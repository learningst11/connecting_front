<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TEST</title>

  <link rel="stylesheet" href="/public/css/reset.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
  <link rel="stylesheet" href="/public/css/common.css">
  <link rel="stylesheet" href="/public/css/sign.css">

  <script src="/public/jquery/jquery-3.6.1.min.js"></script>
  <script src="/common.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>

    document.addEventListener('DOMContentLoaded', function () {

      sessionStorage.setItem('action', 'signup');
      
    });

    async function handleCredentialResponse(response) {
        // ID 토큰 디코드
        const responsePayload = parseJwt(response.credential);

        // 디코드된 페이로드와 ID 토큰 콘솔에 출력
        console.log("Email: " + responsePayload.email); 
        console.log(response.credential);

        // 이메일과 ID 토큰을 세션 스토리지에 저장
        sessionStorage.setItem('email', responsePayload.email);
        sessionStorage.setItem('social_token', response.credential);

        // 소셜 토큰 검증 API 호출
        try {
            const verifyResponse = await fetch("http://your-api-url.com/users/social/verify", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    token: response.credential,
                    platform: "google"
                })
            });

            const verifyData = await verifyResponse.json();

            // 검증 결과에 따른 처리
            if (verifyData.code === 200 && verifyData.data.result === "VERIFIED") {
                // 검증 성공: 회원가입 페이지로 이동
                location.href = "/views/sign_up02.html";
            } else if (verifyData.data.result === "SUCCESS") {
                 // 이미 등록된 회원: 로그인 처리
                sessionStorage.setItem('access_token', verifyData.data.access_token);
                sessionStorage.setItem('refresh_token', verifyData.data.refresh_token);

                // 사용자 인터페이스 업데이트 및 리디렉션
                alert('로그인되었습니다.');
                window.location.href = '/views/home.html'; // 로그인 후 리디렉션할 페이지
            } else {
                // 검증 실패: 오류 메시지 표시
                console.error('토큰 검증 실패');
            }
        } catch (error) {
            console.error('API 요청 실패:', error);
        }
    };


function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
};

        
  </script>

</head>

<body class="pg_sign sign_up01">

  <main>
    <div class="top">
        <a href="javascript:window.history.back();"><img src="/public/img/common/back.svg" alt="back"></a>
    </div>

    <div class="middle">
      <p>회원가입 후
        진정한 성장을 경험하세요!</p>
    </div>

    <div class="bottom">
        <p class="bubble">
          ⚡️ 3초만에 빠른 회원가입
        </p>

      <div class="wrap_btn">

        <div id="g_id_onload"
        data-client_id="266214929436-9acqh2au2h8e05ourhgeuq66v6ldt7cn.apps.googleusercontent.com"
        data-callback="handleCredentialResponse">
   </div>
   <div class="g_id_signin" data-type="icon" data-shape="circle" ></div>


        <button type="button"><img src="/public/img/signup/sign_in_google.svg" alt="sign_in_google">
          <span>구글로 시작하기</span></button>
        
        <button type="button"><img src="/public/img/signup/sign_in_kakao.png" alt="sign_in_kakao"><span>카카오톡으로 시작하기</span></button>

        <div class="wrap_text">
          <hr>
          <span>또는</span>
          <hr>
       </div>

        <button type="button" onclick="location.href='./verify_mobile.html'"><img src="/public/img/signup/sign_in_email.svg" alt="sign_in_email"><span>이메일로 시작하기</span></button>

        <div class="question">
          <p>커넥터즈 계정이 있으신가요?</p>
          <a href='./sign_in.html'>로그인</a>
        </div>
  

      </div>


    </div>

  </main>


</body>

</html>